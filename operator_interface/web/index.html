<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSS Operator Interface</title>
    <link rel="stylesheet" href="style.css?v=<?php echo time(); ?>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Górny pasek statusu -->
        <div class="status-bar-container">
            <div id="connection-status" class="status-indicator status-off">ROZŁĄCZONO</div>
            <div id="autopilot-status" class="status-indicator status-off">AUTOPILOT WYŁĄCZONY</div>
            <button id="toggle-autopilot-btn" class="btn-engage" disabled>AKTYWUJ</button>
        </div>

        <!-- Zakładki -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'TabMain')">Główny</button>
            <button class="tab-button" onclick="openTab(event, 'TabController')">Regulator</button>
            <button class="tab-button" onclick="openTab(event, 'TabControl')">Control</button>
            <button class="tab-button" onclick="openTab(event, 'TabDetails')">Szczegóły</button>
            <button class="tab-button" onclick="openTab(event, 'TabSystem')">System</button>
            <button class="tab-button" onclick="openTab(event, 'TabHealth')">Health</button>
        </div>

        <!-- Zakładka Główna -->
        <div id="TabMain" class="tab-content active">
            <div class="main-panel">
                <h2>Wizualizacja Względna</h2>
                <div id="viz-container">
                    <!-- Sieczkarnia -->
                    <div id="chopper" class="vehicle-symbol" title="Sieczkarnia">
                        <div class="vehicle-icon chopper-simple"></div>
                        <div class="speed-label" id="chopper-speed">0.0 km/h</div>
                    </div>
                    
                    <!-- Ciągnik z przyczepą -->
                    <div id="tractor" class="vehicle-symbol" title="Ciągnik">
                        <div class="vehicle-icon tractor-simple"></div>
                        <div class="speed-label" id="tractor-speed">0.0 km/h</div>
                    </div>
                </div>
            </div>
            <div class="data-panel">
                <h3>Kluczowe Dane</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <span class="data-label">Odległość wzdłużna:</span>
                        <span class="data-value" id="dist_long_main">---</span>
                        <span class="data-unit">m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Odległość poprzeczna:</span>
                        <span class="data-value" id="dist_lat_main">---</span>
                        <span class="data-unit">m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Prędkość:</span>
                        <span class="data-value" id="tractor_speed_main">---</span>
                        <span class="data-unit">km/h</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Prędkość zadana:</span>
                        <span class="data-value" id="target_speed_main">---</span>
                        <span class="data-unit">km/h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zakładka Regulatora -->
        <div id="TabController" class="tab-content">
            <div class="controller-panel">
                <div class="chart-header">
                    <h2>Wykres Pracy Regulatora</h2>
                    <button id="settings-btn" class="btn-settings">⚙️ Nastawy</button>
                </div>
                
                <!-- NOWA SEKCJA: Ustawianie prędkości zadanej -->
                <div class="speed-control-section">
                    <h3>🎯 Ustawianie Prędkości Zadanej</h3>
                    <div class="speed-control-content">
                        <div class="speed-input-group-large">
                            <label for="target-speed-regulator">Prędkość zadana:</label>
                            <div class="speed-input-container">
                                <input type="number" id="target-speed-regulator" min="0" max="20" step="0.1" value="5.0">
                                <span class="unit-large">m/s</span>
                                <button id="set-speed-regulator-btn" class="btn-control-large">Ustaw Prędkość</button>
                            </div>
                        </div>
                        <div class="current-speed-display">
                            <span class="speed-label">Aktualna prędkość:</span>
                            <span class="speed-value" id="current-speed-display">--- m/s</span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="controller-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Zakładka Control -->
        <div id="TabControl" class="tab-content">
            <div class="control-grid">
                <!-- Kontrola Regulatora Prędkości -->
                <div class="control-section">
                    <h3>🚜 Kontrola Regulatora Prędkości</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Status Regulatora:</label>
                            <div class="status-display" id="controller-status">Nieaktywny</div>
                        </div>
                        <div class="control-group">
                            <label>Regulacja Prędkości:</label>
                            <div class="toggle-group">
                                <button id="toggle-speed-controller-btn" class="btn-toggle btn-toggle-off">WYŁĄCZONA</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kontrola Biegów -->
                <div class="control-section">
                    <h3>⚙️ Kontrola Biegów</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Status Gear Manager:</label>
                            <div class="status-display" id="gear-manager-status">Nieaktywny</div>
                        </div>
                        <div class="control-group">
                            <label>Automatyczne Zarządzanie:</label>
                            <div class="toggle-group">
                                <button id="toggle-gear-manager-btn" class="btn-toggle btn-toggle-off">WYŁĄCZONE</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Ręczna Zmiana Biegów:</label>
                            <div class="gear-controls">
                                <button id="gear-up-btn" class="btn-gear btn-gear-up">⬆️ Bieg W GÓRĘ</button>
                                <button id="gear-down-btn" class="btn-gear btn-gear-down">⬇️ Bieg W DÓŁ</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Aktualny Półbieg:</label>
                            <div class="gear-display" id="current-gear-display">---</div>
                        </div>
                    </div>
                </div>

                <!-- NOWA SEKCJA: Ręczne Sterowanie Serwem -->
                <div class="control-section">
                    <h3>🎮 Ręczne Sterowanie Serwem</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Status Serwa:</label>
                            <div class="status-display" id="servo-status-display">Nieznany</div>
                        </div>
                        <div class="control-group">
                            <label>Tryb Sterowania Serwa:</label>
                            <div class="toggle-group">
                                <button id="toggle-servo-mode-btn" class="btn-toggle btn-toggle-off">AUTOMATYCZNY</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Pozycja Docelowa:</label>
                            <div class="servo-input-group">
                                <input type="number" id="servo-target-input" min="0" max="180" step="1" value="90" disabled>
                                <span class="unit">°</span>
                                <button id="set-servo-btn" class="btn-control" disabled>Ustaw Pozycję</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Aktualna Pozycja:</label>
                            <div class="servo-position-display" id="servo-position-display">---°</div>
                        </div>
                        <div class="control-group">
                            <label>Szybkie Pozycje:</label>
                            <div class="servo-quick-controls">
                                <button id="servo-left-btn" class="btn-servo-quick" disabled>⬅️ Lewo (0°)</button>
                                <button id="servo-center-btn" class="btn-servo-quick" disabled>⬆️ Środek (90°)</button>
                                <button id="servo-right-btn" class="btn-servo-quick" disabled>➡️ Prawo (180°)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Systemu -->
                <div class="control-section">
                    <h3>📊 Status Systemu</h3>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Połączenie ROS:</label>
                            <div class="status-indicator-small" id="ros-status-indicator">Rozłączono</div>
                        </div>
                        <div class="control-group">
                            <label>Ostatnia Komenda:</label>
                            <div class="last-command" id="last-command">Brak</div>
                        </div>
                        <div class="control-group">
                            <label>Status Serwa:</label>
                            <div class="status-indicator-small" id="servo-status-indicator">Nieznany</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zakładka Szczegółów -->
        <div id="TabDetails" class="tab-content">
            <div class="details-grid">
                <!-- Status Systemu -->
                <div class="detail-section">
                    <h3>🔧 Status Systemu</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Połączenie BT:</span>
                            <span class="detail-value" id="bt_status">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">RTK Ciągnika:</span>
                            <span class="detail-value" id="tractor_rtk">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">RTK Sieczkarni:</span>
                            <span class="detail-value" id="chopper_rtk">---</span>
                        </div>
                    </div>
                </div>

                <!-- Ciągnik -->
                <div class="detail-section">
                    <h3>🚜 Ciągnik</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Prędkość:</span>
                            <span class="detail-value" id="tractor_speed">---</span>
                            <span class="detail-unit">km/h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Prędkość zadana:</span>
                            <span class="detail-value" id="target_speed">---</span>
                            <span class="detail-unit">km/h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Półbieg:</span>
                            <span class="detail-value" id="gear">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Sprzęgło:</span>
                            <span class="detail-value" id="clutch">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pozycja serwa:</span>
                            <span class="detail-value" id="servo_pos">---</span>
                            <span class="detail-unit">°</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Szerokość geograficzna:</span>
                            <span class="detail-value" id="tractor_lat">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Długość geograficzna:</span>
                            <span class="detail-value" id="tractor_lon">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Wysokość:</span>
                            <span class="detail-value" id="tractor_alt">---</span>
                            <span class="detail-unit">m</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kurs:</span>
                            <span class="detail-value" id="tractor_heading">---</span>
                            <span class="detail-unit">°</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Czas GPS:</span>
                            <span class="detail-value" id="tractor_gps_time">---</span>
                        </div>
                    </div>
                </div>

                <!-- Sieczkarnia -->
                <div class="detail-section">
                    <h3>🌾 Sieczkarnia</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Prędkość:</span>
                            <span class="detail-value" id="chopper_speed">---</span>
                            <span class="detail-unit">km/h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Szerokość geograficzna:</span>
                            <span class="detail-value" id="chopper_lat">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Długość geograficzna:</span>
                            <span class="detail-value" id="chopper_lon">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Wysokość:</span>
                            <span class="detail-value" id="chopper_alt">---</span>
                            <span class="detail-unit">m</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kurs:</span>
                            <span class="detail-value" id="chopper_heading">---</span>
                            <span class="detail-unit">°</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Czas GPS:</span>
                            <span class="detail-value" id="chopper_gps_time">---</span>
                        </div>
                    </div>
                </div>

                <!-- Pozycja Względna -->
                <div class="detail-section">
                    <h3>📍 Pozycja Względna</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Wzdłużna:</span>
                            <span class="detail-value" id="dist_long">---</span>
                            <span class="detail-unit">m</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Poprzeczna:</span>
                            <span class="detail-value" id="dist_lat">---</span>
                            <span class="detail-unit">m</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Prosta:</span>
                            <span class="detail-value" id="dist_straight">---</span>
                            <span class="detail-unit">m</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOWA ZAKŁADKA: System -->
        <div id="TabSystem" class="tab-content">
            <div class="details-grid">
                <!-- Monitoring Systemu RPi -->
                <div class="detail-section">
                    <h3>🖥️ Monitoring Systemu RPi</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">CPU:</span>
                            <span class="detail-value" id="system_cpu">---</span>
                            <span class="detail-unit">%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">RAM:</span>
                            <span class="detail-value" id="system_ram">---</span>
                            <span class="detail-unit">%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Temperatura:</span>
                            <span class="detail-value" id="system_temp">---</span>
                            <span class="detail-unit">°C</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Dysk:</span>
                            <span class="detail-value" id="system_disk">---</span>
                            <span class="detail-unit">%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Uptime:</span>
                            <span class="detail-value" id="system_uptime">---</span>
                            <span class="detail-unit">h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status GPIO:</span>
                            <span class="detail-value" id="system_gpio">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status Sieci:</span>
                            <span class="detail-value" id="system_network">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Porty USB/Serial:</span>
                            <span class="detail-value" id="system_usb_serial">---</span>
                        </div>
                    </div>
                </div>

                <!-- Status Połączeń -->
                <div class="detail-section">
                    <h3>🔌 Status Połączeń</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">ROS Bridge:</span>
                            <span class="detail-value" id="ros_bridge_status">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">GPS RTK:</span>
                            <span class="detail-value" id="gps_rtk_status">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Bluetooth:</span>
                            <span class="detail-value" id="bluetooth_status">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">IMU:</span>
                            <span class="detail-value" id="imu_status">---</span>
                        </div>
                    </div>
                </div>

                <!-- Informacje o Systemie -->
                <div class="detail-section">
                    <h3>ℹ️ Informacje o Systemie</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Wersja ROS:</span>
                            <span class="detail-value" id="ros_version">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Architektura:</span>
                            <span class="detail-value" id="system_arch">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Model RPi:</span>
                            <span class="detail-value" id="rpi_model">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ostatnia Aktualizacja:</span>
                            <span class="detail-value" id="last_update">---</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOWA ZAKŁADKA: Health -->
        <div id="TabHealth" class="tab-content">
            <div class="details-grid">
                <!-- Ogólny Status Systemu -->
                <div class="detail-section">
                    <h3>🏥 Ogólny Status Systemu</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Status Ogólny:</span>
                            <span class="detail-value" id="overall_system_status">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Węzły Aktywne:</span>
                            <span class="detail-value" id="active_nodes_count">---</span>
                            <span class="detail-unit">/ 12</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Węzły z Błędami:</span>
                            <span class="detail-value" id="error_nodes_count">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ostatnia Aktualizacja:</span>
                            <span class="detail-value" id="health_last_update">---</span>
                        </div>
                    </div>
                </div>

                <!-- Status Poszczególnych Węzłów -->
                <div class="detail-section">
                    <h3>🔍 Status Węzłów</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">GPS RTK Node:</span>
                            <span class="detail-value" id="node_gps_rtk">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">BT Receiver:</span>
                            <span class="detail-value" id="node_bt_receiver">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gear Reader:</span>
                            <span class="detail-value" id="node_gear_reader">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Servo Controller:</span>
                            <span class="detail-value" id="node_servo_controller">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gear Shifter:</span>
                            <span class="detail-value" id="node_gear_shifter">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Speed Filter:</span>
                            <span class="detail-value" id="node_speed_filter">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Speed Controller:</span>
                            <span class="detail-value" id="node_speed_controller">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Relative Computer:</span>
                            <span class="detail-value" id="node_relative_computer">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gear Manager:</span>
                            <span class="detail-value" id="node_gear_manager">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Diagnostics:</span>
                            <span class="detail-value" id="node_diagnostics">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">System Monitor:</span>
                            <span class="detail-value" id="node_system_monitor">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Health Monitor:</span>
                            <span class="detail-value" id="node_health_monitor">---</span>
                        </div>
                    </div>
                </div>

                <!-- Alerty i Ostrzeżenia -->
                <div class="detail-section">
                    <h3>⚠️ Alerty i Ostrzeżenia</h3>
                    <div class="detail-content">
                        <div class="detail-item">
                            <span class="detail-label">Ostatni Alert:</span>
                            <span class="detail-value" id="last_alert">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Poziom Alertu:</span>
                            <span class="detail-value" id="alert_level">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Liczba Alertów:</span>
                            <span class="detail-value" id="alerts_count">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Czas Alertu:</span>
                            <span class="detail-value" id="alert_timestamp">---</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal z nastawami -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Nastawy Regulatora PI</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label for="kp-slider">Kp (Wzmocnienie): <span id="kp-value">10.0</span></label>
                    <input type="range" id="kp-slider" min="0" max="100" value="10" step="0.5">
                </div>
                <div class="settings-group">
                    <label for="ki-slider">Ki (Całka): <span id="ki-value">20.0</span></label>
                    <input type="range" id="ki-slider" min="0" max="100" value="20" step="0.5">
                </div>
                <button id="apply-pid-btn" class="btn-apply">Zastosuj Parametry</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="main.js"></script>
</body>
</html>
